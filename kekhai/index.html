<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="·ª®ng d·ª•ng k√™ khai doanh thu cho h·ªô kinh doanh - M·∫´u S1a-HKD">
    <meta name="theme-color" content="#1e3c72">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="K√™ Khai">
    
    <title>S·ªï Chi Ti·∫øt Doanh Thu - M·∫´u S1a-HKD</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4878455337844727"
     crossorigin="anonymous"></script>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div>
                    <h1>S·ªï Chi Ti·∫øt Doanh Thu B√°n H√†ng H√≥a, D·ªãch V·ª•</h1>
                    <p class="subtitle">M·∫´u s·ªë S1a-HKD</p>
                </div>
            </div>
        </header>

        <div class="main-content">
            <!-- Sidebar: Danh s√°ch h·ªô kinh doanh ƒë√£ l∆∞u -->
            <aside class="sidebar">
                <h3>H·ªô Kinh Doanh ƒê√£ L∆∞u</h3>
                <div id="savedList"></div>
                <div class="sidebar-actions">
                    <button class="btn btn-new" onclick="createNew()">+ T·∫°o m·ªõi</button>
                </div>
            </aside>

            <!-- Form nh·∫≠p li·ªáu -->
            <main class="form-section">
                <form id="businessForm">
                    <section class="info-section">
                        <h3>Th√¥ng tin H·ªô Kinh Doanh</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="businessName">H·ªô, c√° nh√¢n kinh doanh:</label>
                                <input type="text" id="businessName" required>
                            </div>
                            <div class="form-group">
                                <label for="address">ƒê·ªãa ch·ªâ:</label>
                                <input type="text" id="address" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="taxCode">M√£ s·ªë thu·∫ø:</label>
                                <input type="text" id="taxCode" required>
                            </div>
                            <div class="form-group">
                                <label for="businessLocation">ƒê·ªãa ƒëi·ªÉm kinh doanh:</label>
                                <input type="text" id="businessLocation">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="declarationPeriod">K·ª≥ k√™ khai:</label>
                                <input type="text" id="declarationPeriod" placeholder="VD: Qu√Ω 4/2025">
                            </div>
                            <div class="form-group">
                                <label for="representative">Ng∆∞·ªùi ƒë·∫°i di·ªán:</label>
                                <input type="text" id="representative">
                            </div>
                        </div>
                    </section>

                    <section class="transactions-section">
                        <h3>Chi Ti·∫øt Giao D·ªãch</h3>
                        <div class="table-wrapper">
                            <table id="transactionTable">
                                <thead>
                                    <tr>
                                        <th style="width: 150px;">Ng√†y th√°ng</th>
                                        <th>Giao d·ªãch</th>
                                        <th style="width: 150px;">S·ªë ti·ªÅn</th>
                                        <th style="width: 50px;">X√≥a</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionBody">
                                </tbody>
                                <tfoot>
                                    <tr class="total-row">
                                        <td></td>
                                        <td style="text-align: left;">T·ªïng c·ªông:</td>
                                        <td id="totalAmount">0</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <button type="button" class="btn btn-add" onclick="addRow()">+ Th√™m d√≤ng</button>
                    </section>

                    <section class="date-section">
                        <h3>Ng√†y k√™ khai</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="signDay">Ng√†y:</label>
                                <input type="number" id="signDay" min="1" max="31" value="22">
                            </div>
                            <div class="form-group">
                                <label for="signMonth">Th√°ng:</label>
                                <input type="number" id="signMonth" min="1" max="12" value="12">
                            </div>
                            <div class="form-group">
                                <label for="signYear">NƒÉm:</label>
                                <input type="number" id="signYear" min="2020" max="2100" value="2025">
                            </div>
                        </div>
                    </section>

                    <div class="action-buttons">
                        <button type="button" class="btn btn-save" onclick="saveData()">L∆∞u th√¥ng tin</button>
                        <button type="button" class="btn btn-preview" onclick="showPreview()">Xem tr∆∞·ªõc</button>
                    </div>
                </form>
            </main>
        </div>
    </div>

    <button id="installBtn" class="btn btn-install">
        C√†i ƒë·∫∑t App
    </button>

    <!-- Modal xem tr∆∞·ªõc -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Xem Tr∆∞·ªõc VƒÉn B·∫£n</h2>
                <span class="close" onclick="closePreview()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="previewContent"></div>
            </div>
            <div class="modal-footer">
                <div class="orientation-select">
                    <label>H∆∞·ªõng gi·∫•y:</label>
                    <select id="pageOrientation">
                        <option value="landscape">Ngang (Landscape)</option>
                        <option value="portrait">D·ªçc (Portrait)</option>
                    </select>
                </div>
                <button class="btn btn-word" onclick="exportWord()">T·∫£i Word</button>
                <button class="btn btn-pdf" onclick="exportPDF()">T·∫£i PDF</button>
                <button class="btn btn-close" onclick="closePreview()">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="config.js"></script>
    <script src="app.js"></script>
    
    <!-- ƒêƒÉng k√Ω Service Worker v√† x·ª≠ l√Ω c√†i ƒë·∫∑t PWA -->
    <script>
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');

        // ƒêƒÉng k√Ω Service Worker (ch·ªâ tr√™n http/https, kh√¥ng ph·∫£i file://)
        if ('serviceWorker' in navigator && location.protocol !== 'file:') {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker ƒë√£ ƒëƒÉng k√Ω'))
                    .catch(err => console.log('L·ªói ƒëƒÉng k√Ω SW:', err));
            });
        }

        // B·∫Øt s·ª± ki·ªán tr∆∞·ªõc khi hi·ªán prompt c√†i ƒë·∫∑t
        window.addEventListener('beforeinstallprompt', (e) => {
            // NgƒÉn Chrome hi·ªán prompt t·ª± ƒë·ªông
            e.preventDefault();
            // L∆∞u event ƒë·ªÉ d√πng sau
            deferredPrompt = e;
            // Hi·ªán n√∫t c√†i ƒë·∫∑t
            installBtn.style.display = 'block';
        });

        // X·ª≠ l√Ω khi nh·∫•n n√∫t c√†i ƒë·∫∑t
        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) {
                // N·∫øu kh√¥ng c√≥ prompt (ƒë√£ c√†i ho·∫∑c kh√¥ng h·ªó tr·ª£)
                alert('ƒê·ªÉ c√†i ƒë·∫∑t app:\n\nüì± iPhone: Nh·∫•n n√∫t Chia s·∫ª ‚Üí "Th√™m v√†o MH ch√≠nh"\n\nüì± Android: Nh·∫•n menu ‚ãÆ ‚Üí "C√†i ƒë·∫∑t ·ª©ng d·ª•ng"');
                return;
            }
            
            // Hi·ªán prompt c√†i ƒë·∫∑t
            deferredPrompt.prompt();
            
            // ƒê·ª£i ng∆∞·ªùi d√πng ch·ªçn
            const { outcome } = await deferredPrompt.userChoice;
            console.log('K·∫øt qu·∫£ c√†i ƒë·∫∑t:', outcome);
            
            // Reset
            deferredPrompt = null;
            installBtn.style.display = 'none';
        });

        // ·∫®n n√∫t khi ƒë√£ c√†i ƒë·∫∑t
        window.addEventListener('appinstalled', () => {
            console.log('App ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t');
            installBtn.style.display = 'none';
            deferredPrompt = null;
        });

        // Ki·ªÉm tra n·∫øu ƒëang ch·∫°y trong standalone mode (ƒë√£ c√†i)
        if (window.matchMedia('(display-mode: standalone)').matches) {
            installBtn.style.display = 'none';
        }
    </script>
</body>
</html>
